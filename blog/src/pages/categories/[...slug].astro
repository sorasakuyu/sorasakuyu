---
import CategoryPostList from '@components/category/CategoryPostList.astro';
import HomeSider from '@components/layout/HomeSider.astro';
import Cover from '@components/ui/cover/Cover.astro';
import { seoConfig } from '@constants/site-config';
import Layout from '@layouts/Layout.astro';
import TwoColumnLayout from '@layouts/TwoColumnLayout.astro';
import { getCategoryByLink, getCategoryLinks, getCategoryList, translateCategoryName } from '@lib/content';
import { defaultLocale, getLocaleFromUrl, t } from '@/i18n';

export async function getStaticPaths() {
  const { categories } = await getCategoryList(defaultLocale);
  const links = getCategoryLinks(categories, '');
  return links.map((link) => {
    const category = getCategoryByLink(categories, link);
    return {
      params: { slug: link },
      props: { category },
    };
  });
}

const { category: propCategory } = Astro.props;
const locale = getLocaleFromUrl(Astro.url.pathname);
const { categories: allCategories, countMap } = await getCategoryList(locale);

// Re-derive category from locale-aware data to ensure consistency with countMap.
// When rendered by [lang]/ mirrors, propCategory comes from a different getCategoryList call;
// re-deriving from the same data source prevents subtle mismatches.
const slug = Astro.params.slug;
const category = slug ? getCategoryByLink(allCategories, slug) : propCategory;

// 如果是子分类，只展示当前分类的内容
const displayCategories = category ? [category] : allCategories;
---

<Layout title={`${t(locale, 'category.postsInCategory', { name: translateCategoryName(category?.name ?? '', locale) })} | ${seoConfig.title}`}>
  <TwoColumnLayout>
    <Cover slot="cover" title={t(locale, 'category.postsInCategory', { name: translateCategoryName(category?.name ?? '', locale) })} />
    <HomeSider slot="sider" />
    <CategoryPostList rootCategory={category} categories={displayCategories} countMap={countMap} />
  </TwoColumnLayout>
</Layout>
