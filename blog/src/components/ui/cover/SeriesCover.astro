---
import type { FeaturedSeriesItem } from '@lib/config/types';
import { translateSeriesField } from '@lib/content';
import { getLqipStyle } from '@lib/lqip';
import { getSanitizeHtml } from '@lib/sanitize';
import { Icon } from 'astro-icon/components';
import { marked } from 'marked';
import { MAX_WIDTH } from '@/constants/layout';
import { getLocaleFromUrl, t } from '@/i18n';
import WaveSvg from './wave';

interface Props {
  series: FeaturedSeriesItem;
}

const { series } = Astro.props;
const locale = getLocaleFromUrl(Astro.url.pathname);

// Translate series fields with fallback to YAML values
const seriesLabel = translateSeriesField(series.slug, 'label', series.label, locale);
const seriesFullName = translateSeriesField(series.slug, 'fullName', series.fullName, locale);
const seriesTitle = seriesFullName || seriesLabel || series.categoryName;

// Convert Markdown description to HTML and sanitize for XSS protection
const rawHtml = series.description ? await marked.parse(series.description) : '';
const descriptionHtml = getSanitizeHtml(rawHtml);
---

<div class="relative flex z-0 max-h-200 min-h-[70dvh] items-center justify-center overflow-hidden pb-6">
  <div class="absolute inset-0 h-full bg-black/40"></div>
  <!-- Series cover image -->
  {
    series.cover && (
      <div class="absolute inset-0 -z-10 h-full w-full" style={getLqipStyle(series.cover)}>
        <img
          src={series.cover}
          alt={seriesTitle}
          class="h-full w-full object-cover"
          loading="eager"
          fetchpriority="high"
          decoding="async"
        />
      </div>
    )
  }

  <!-- Main content area -->
  <div class={`relative z-10 flex flex-col items-center justify-center px-5 py-4 text-white ${MAX_WIDTH.content}`}>
    <!-- Title -->
    <h1 class="shadow-text text-center text-5xl font-bold md:text-3xl">
      {seriesTitle}
    </h1>

    <!-- Link buttons -->
    {
      series.links && (
        <div class="mt-6 flex flex-wrap items-center justify-center gap-3">
          {series.links.github && (
            <a
              href={series.links.github}
              target="_blank"
              class="flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm backdrop-blur-sm transition-all hover:scale-105 hover:bg-white/20"
            >
              <Icon name="ri:github-fill" class="h-5 w-5" />
              <span>GitHub</span>
            </a>
          )}
          {series.links.rss && (
            <a
              href={series.links.rss}
              target="_blank"
              data-astro-reload
              class="flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm backdrop-blur-sm transition-all hover:scale-105 hover:bg-white/20"
            >
              <Icon name="ri:rss-line" class="h-5 w-5" />
              <span>{t(locale, 'series.rss')}</span>
            </a>
          )}
          {series.links.chrome && (
            <a
              href={series.links.chrome}
              target="_blank"
              class="flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm backdrop-blur-sm transition-all hover:scale-105 hover:bg-white/20"
            >
              <Icon name="ri:chrome-fill" class="h-5 w-5" />
              <span>{t(locale, 'series.chromeExtension')}</span>
            </a>
          )}
          {series.links.docs && (
            <a
              href={series.links.docs}
              target="_blank"
              class="flex items-center gap-2 rounded-full bg-white/10 px-4 py-2 text-sm backdrop-blur-sm transition-all hover:scale-105 hover:bg-white/20"
            >
              <Icon name="ri:book-open-line" class="h-5 w-5" />
              <span>{t(locale, 'series.docs')}</span>
            </a>
          )}
        </div>
      )
    }

    <!-- Description -->
    {
      series.description && (
        <div class="shadow-text mt-8 max-w-3xl text-center">
          <div class="prose prose-invert mx-auto text-sm leading-relaxed md:text-xs" set:html={descriptionHtml} />
        </div>
      )
    }
  </div>

  <WaveSvg />
</div>
