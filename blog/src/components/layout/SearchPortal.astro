---
import Search from 'astro-pagefind/components/Search';
/**
 * SearchPortal Component
 *
 * Provides the Pagefind search UI that gets portal'd into SearchDialog.
 * Listens for search-dialog-open/close events to move the search component.
 *
 * TODO(i18n): Pagefind search result links are not locale-aware â€” they always
 * point to root-level URLs (e.g., /post/xxx) regardless of the current locale.
 * A future iteration could use custom result rendering to prepend locale prefix.
 */
import { getLocaleFromUrl, t } from '@/i18n';

const locale = getLocaleFromUrl(Astro.url.pathname);
---

<!-- Search Component - will be portal'd into dialog -->
<div id="search-component-portal">
  <Search
    id="search-for-dialog"
    className="pagefind-ui"
    uiOptions={{
      showImages: false,
      resetStyles: false,
      translations: {
        placeholder: t(locale, 'search.placeholder'),
        clear_search: t(locale, 'search.clear'),
        load_more: t(locale, 'search.loadMore'),
        search_label: t(locale, 'search.label'),
        filters_label: t(locale, 'search.filters'),
        zero_results: t(locale, 'search.noResults'),
        many_results: t(locale, 'search.manyResults'),
        one_result: t(locale, 'search.oneResult'),
        alt_search: t(locale, 'search.altSearch'),
        search_suggestion: t(locale, 'search.suggestion'),
        searching: t(locale, 'search.searching'),
      },
    }}
  />
</div>

<script>
  function moveSearchToDialog() {
    const dialogContainer = document.getElementById('search-dialog-container');
    const searchPortal = document.getElementById('search-component-portal');
    const searchComponent = document.getElementById('search-for-dialog');

    if (!dialogContainer || !searchPortal || !searchComponent) return;

    // Check if search component is already in the dialog
    if (dialogContainer.contains(searchComponent)) return;

    // Move search component to dialog
    dialogContainer.appendChild(searchComponent);
  }

  function moveSearchBack() {
    const searchComponent = document.getElementById('search-for-dialog');
    const searchPortal = document.getElementById('search-component-portal');

    if (!searchComponent || !searchPortal) return;

    // Move search component back to portal if it's not already there
    if (!searchPortal.contains(searchComponent)) {
      searchPortal.appendChild(searchComponent);
    }
  }

  function handleDialogOpen() {
    // Small delay to ensure dialog container is rendered
    requestAnimationFrame(() => {
      moveSearchToDialog();
    });
  }

  function handleDialogClose() {
    // Move search back immediately before DOM is removed
    moveSearchBack();
  }

  let initialized = false;

  function initSearchPortal() {
    if (initialized) return;
    initialized = true;

    window.addEventListener('search-dialog-open', handleDialogOpen);
    window.addEventListener('search-dialog-close', handleDialogClose);
  }

  function cleanupSearchPortal() {
    if (!initialized) return;

    window.removeEventListener('search-dialog-open', handleDialogOpen);
    window.removeEventListener('search-dialog-close', handleDialogClose);
    initialized = false;
  }

  // Initialize immediately if DOM is ready
  if (document.readyState !== 'loading') {
    initSearchPortal();
  }

  document.addEventListener('astro:page-load', initSearchPortal);
  document.addEventListener('astro:before-swap', cleanupSearchPortal);
</script>

<style>
  /* Hide the portal container */
  #search-component-portal {
    display: none;
    position: absolute;
    pointer-events: none;
    visibility: hidden;
  }
</style>
<style is:global>
  /* Ensure search is visible when in dialog */
  #search-dialog-container #search-for-dialog {
    display: block !important;
    visibility: visible !important;
    pointer-events: auto !important;
  }
</style>
