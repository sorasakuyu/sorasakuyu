---
import ChristmasHat from '@components/christmas/ChristmasHat.astro';
import ButtonLink from '@components/control/ButtonLink.astro';
import type { HomeSiderType } from '@constants/enum';
import { RESERVED_ROUTES, routers } from '@constants/router';
import { christmasConfig, configuredSeriesSlugs, enabledSeriesSlugs, siteConfig } from '@constants/site-config';
import { getAllTags, getCategoryList, getPostCount, getSortedPosts } from '@lib/content';
import { getLqipStyle } from '@lib/lqip';
import { cn, filterNavItems } from '@lib/utils';
import { Icon } from 'astro-icon/components';
import { getLocaleFromUrl, localizedPath, resolveNavName, stripLocaleFromPath, t } from '@/i18n';
import type { BlogSchema } from '@/types/blog';
import Social from './Social.astro';

interface Props {
  type?: HomeSiderType;
  className?: string;
  isDrawer?: boolean;
  frontmatter?: BlogSchema;
}

const locale = getLocaleFromUrl(Astro.url.pathname);
const postCount = await getPostCount(locale);
const { countMap } = await getCategoryList(locale);
const posts = await getSortedPosts(locale);
const tags = getAllTags(posts);

const allTags = Object.entries(tags).map(([tag, count]) => ({ tag, count }));

// 生成唯一 ID 前缀
const uniqueId = `home-info-${Math.random().toString(36).substring(2, 11)}`;
const { className } = Astro.props;

// Filter navigation items to exclude disabled series
const filteredRouters = filterNavItems(routers, configuredSeriesSlugs, enabledSeriesSlugs, RESERVED_ROUTES);
const strippedPath = stripLocaleFromPath(Astro.url.pathname);
---

<div class={cn('flex flex-col items-center', className)} data-home-info-container={uniqueId}>
  <div class="relative h-40 w-40 rounded-full" style={getLqipStyle(siteConfig.avatar ?? '/img/avatar.webp')}>
    <img
      transition:persist="page-home-info-avatar"
      class="shadow-card-darker hover:animate-shake h-full w-full rounded-full transition"
      src={siteConfig.avatar ?? '/img/avatar.webp'}
      alt={`${siteConfig.name ?? ''} avatar`}
      loading="eager"
      fetchpriority="high"
    />
    {christmasConfig.enabled && christmasConfig.features.christmasHat && <ChristmasHat />}
  </div>

  <p class="mt-2">{siteConfig?.name}</p>
  <p class="text-muted-foreground mt-3 text-center">{siteConfig?.description}</p>
  <Social />
  <div
    class="text-muted-foreground mt-3 flex justify-center text-center text-sm/4 whitespace-nowrap select-none dark:text-white/80"
  >
    <a href={localizedPath('/', locale)} class="hover:text-blue flex cursor-pointer flex-col gap-2 p-1 transition">
      <span class="text-lg/5 font-bold">{postCount}</span>
      {t(locale, 'homeInfo.articles')}
    </a>
    <div class="bg-muted-foreground mx-3 w-px"></div>
    <a href={localizedPath('/categories', locale)} aria-label={t(locale, 'homeInfo.categories')} class="hover:text-blue">
      <p class="flex cursor-pointer flex-col gap-2 p-1 transition">
        <span class="text-lg/5 font-bold">{Object.keys(countMap).length}</span>
        {t(locale, 'homeInfo.categories')}
      </p>
    </a>
    <div class="bg-muted-foreground mx-3 w-px"></div>
    <a href={localizedPath('/tags', locale)} class="hover:text-blue flex cursor-pointer flex-col gap-2 p-1 transition">
      <span class="text-lg/5 font-bold">{allTags?.length ?? 0}</span>
      {t(locale, 'homeInfo.tags')}
    </a>
  </div>
  <div class="mt-6 flex w-full flex-col items-center gap-2.5">
    {
      filteredRouters.map((item, index) => {
        const displayName = resolveNavName(item.nameKey, item.name, locale);
        if (item.children?.length) {
          const collapseId = `${uniqueId}-collapse-${index}`;
          return (
            <div
              class="bg-foreground/10 flex w-40 flex-col rounded-xl opacity-75 transition-all duration-300 hover:opacity-100"
              data-collapsible
            >
              <button
                class="flex-center hover:bg-foreground/5 h-12 w-full cursor-pointer rounded-xl transition-colors"
                data-collapse-trigger={collapseId}
                aria-expanded="false"
                aria-label={t(locale, 'common.menuLabel', { name: displayName })}
                type="button"
              >
                {item.icon && <Icon name={item.icon} class="mr-1.5" />}
                {displayName}
                <Icon
                  name="ri:arrow-down-s-line"
                  class="ml-2 size-5 transition-transform duration-300"
                  data-collapse-icon={collapseId}
                />
              </button>
              <div class="collapse-hidden" data-collapse-content={collapseId}>
                <div class="flex flex-col items-center">
                  {item.children.map((child) => {
                    const childName = resolveNavName(child.nameKey, child.name, locale);
                    const childUrl = child.path ? localizedPath(child.path, locale) : child.path;
                    return (
                      <ButtonLink
                        url={childUrl}
                        label={childName}
                        variant="gradient-shoka"
                        className={cn('shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider', {
                          'text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none':
                            child.path !== strippedPath,
                        })}
                      >
                        {child.icon && <Icon name={child.icon} class="mr-1.5" />}
                        {childName}
                      </ButtonLink>
                    );
                  })}
                </div>
              </div>
            </div>
          );
        }
        const itemUrl = item.path ? localizedPath(item.path, locale) : item.path;
        return (
          <ButtonLink
            url={itemUrl}
            label={displayName}
            variant="gradient-shoka"
            className={cn(
              'shoka-button-shadow h-12 w-40 rounded-xl text-base tracking-wider opacity-75 transition-all duration-300 hover:opacity-100',
              {
                'text-muted-foreground/80 hover:bg-muted-foreground/10 bg-none shadow-none hover:shadow-none':
                  item.path !== strippedPath,
              },
            )}
          >
            {item.icon && <Icon name={item.icon} class="mr-1.5" />}
            {displayName}
          </ButtonLink>
        );
      })
    }
  </div>
</div>

<style>
  /* 折叠动画使用 CSS Grid 技巧实现平滑的高度过渡 */
  [data-collapse-content] {
    display: grid;
    grid-template-rows: 1fr;
  }

  [data-collapse-content] > div {
    min-height: 0;
    overflow: hidden;
  }

  [data-collapse-content].collapse-hidden {
    grid-template-rows: 0fr;
  }

  /* 只在用户未设置 reduce-motion 时应用动画 */
  @media (prefers-reduced-motion: no-preference) {
    [data-collapse-content] {
      transition: grid-template-rows 0.3s ease;
    }
  }
</style>
<script>
  let collapseMutationObserver: MutationObserver | null = null;

  function initCollapsible() {
    // 找到所有 HomeInfo 容器
    const containers = document.querySelectorAll('[data-home-info-container]');

    containers.forEach((container) => {
      const triggers = container.querySelectorAll('[data-collapse-trigger]');

      triggers.forEach((trigger) => {
        const targetId = trigger.getAttribute('data-collapse-trigger');
        if (!targetId) return;

        // 检查是否已经初始化过
        if (trigger.hasAttribute('data-initialized')) return;
        trigger.setAttribute('data-initialized', 'true');

        // 在当前容器内查找对应的元素
        const content = container.querySelector(`[data-collapse-content="${targetId}"]`) as HTMLElement;
        const icon = trigger.querySelector(`[data-collapse-icon="${targetId}"]`) as HTMLElement;

        if (!content || !icon) return;

        trigger.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();

          const isExpanded = trigger.getAttribute('aria-expanded') === 'true';

          if (isExpanded) {
            // 折叠
            content.classList.add('collapse-hidden');
            icon.style.transform = 'rotate(0deg)';
            trigger.setAttribute('aria-expanded', 'false');
          } else {
            // 展开
            content.classList.remove('collapse-hidden');
            icon.style.transform = 'rotate(180deg)';
            trigger.setAttribute('aria-expanded', 'true');
          }
        });
      });
    });
  }

  function cleanupObserver() {
    if (collapseMutationObserver) {
      collapseMutationObserver.disconnect();
      collapseMutationObserver = null;
    }
  }

  function setupObserver() {
    // 先清理旧的观察器
    cleanupObserver();

    // 支持 MobileDrawer 延迟加载
    collapseMutationObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.addedNodes.length) {
          setTimeout(initCollapsible, 100);
        }
      });
    });

    collapseMutationObserver.observe(document.body, {
      childList: true,
      subtree: true,
    });
  }

  // 初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initCollapsible();
      setupObserver();
    });
  } else {
    initCollapsible();
    setupObserver();
  }

  // 支持 Astro 的视图过渡
  document.addEventListener('astro:page-load', () => {
    initCollapsible();
    setupObserver();
  });

  // 页面切换前清理观察器
  document.addEventListener('astro:before-swap', cleanupObserver);
</script>
