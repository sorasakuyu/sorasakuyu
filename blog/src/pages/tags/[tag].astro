---
import HomeSider from '@components/layout/HomeSider.astro';
import Cover from '@components/ui/cover/Cover.astro';
import { CONTENT_PADDING } from '@constants/layout';
import { siteConfig } from '@constants/site-config';
import Layout from '@layouts/Layout.astro';
import TwoColumnLayout from '@layouts/TwoColumnLayout.astro';
import { getPostLastCategory, getPostSlug, getSortedPosts, normalizeTag, translateCategoryName } from '@lib/content';
import { displayDate } from '@lib/date';
import { encodeSlug } from '@lib/route';
import { defaultLocale, getLocaleFromUrl, localizedPath, t } from '@/i18n';

export async function getStaticPaths() {
  const posts = await getSortedPosts(defaultLocale);
  const tags = new Set<string>();

  for (const post of posts) {
    const postTags = post.data.tags || [];
    for (const tag of postTags) {
      tags.add(normalizeTag(tag));
    }
  }

  return Array.from(tags).map((tag) => ({
    params: { tag: normalizeTag(tag).replace(/\//g, '-') },
    props: {
      posts: posts.filter((post) => post.data.tags?.some((tg) => normalizeTag(tg) === tag)),
      tag,
    },
  }));
}

const { tag, posts } = Astro.props;
const locale = getLocaleFromUrl(Astro.url.pathname);
---

<Layout title={`${t(locale, 'tag.postsWithTag', { name: tag })} | ${siteConfig.title}`} description={t(locale, 'tag.postsWithTag', { name: tag })}>
  <TwoColumnLayout>
    <Cover slot="cover" title={t(locale, 'tag.postsWithTag', { name: tag })} />
    <HomeSider slot="sider" />
    <div class={`shadow-box mx-0 flex w-full flex-col bg-gradient-start ${CONTENT_PADDING.standard}`}>
      <h2 class="shoka-decoration-circle has-children group relative h-19 px-6 py-5 text-2xl/9 font-bold">
        <a
          href={localizedPath('/tags', locale)}
          class="dashed-border text-muted-foreground group-hover:border-blue group-hover:text-blue border-b">{t(locale, 'tag.all')}</a
        >
        <span class="text-muted-foreground text-lg"> / </span>
        <span class="text-muted-foreground">{tag}</span>
        <span class="text-muted-foreground text-lg">({t(locale, 'tag.postCount', { count: posts.length })})</span>
      </h2>
      {
        posts?.length && (
          <div class="category-second-level-container flex flex-col">
            {posts.map((post) => {
              const { link, name } = getPostLastCategory(post);
              return (
                <p class="shoka-decoration-circle group text-primary relative px-6 py-2 text-base/9 md:overflow-visible">
                  <span class="text-muted-foreground inline-block w-15 text-xs md:relative md:-top-1">
                    {displayDate.shortDate(post.data.date)}
                  </span>
                  <a
                    href={localizedPath(link, locale)}
                    class="text-muted-foreground hover:text-blue mr-2 inline-block text-xs md:relative md:-top-1"
                  >
                    {translateCategoryName(name, locale)}
                  </a>
                  <a href={localizedPath(`/post/${encodeSlug(getPostSlug(post))}`, locale)} class="dashed-border md:absolute md:top-7 md:left-7">
                    {post?.data?.title}
                  </a>
                </p>
              );
            })}
          </div>
        )
      }
    </div>
  </TwoColumnLayout>
</Layout>
