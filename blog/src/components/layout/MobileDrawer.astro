---
import { HomeSiderType } from '@constants/enum';
import { Icon } from 'astro-icon/components';
import type { BlogPost } from 'types/blog';
import { getAlternateUrl, getLocaleFromUrl, getLocaleLabel, localeEntries, t } from '@/i18n';
import HomeSider from './HomeSider.astro';

interface Props {
  type?: HomeSiderType;
  post?: BlogPost;
}

const { type = HomeSiderType.HOME, post } = Astro.props;
const locale = getLocaleFromUrl(Astro.url.pathname);
---

<!-- 遮罩层 -->
<div id="drawer-overlay" class="fixed inset-0 z-40 hidden bg-black/50" role="presentation" aria-hidden="true"></div>

<!-- 移动端抽屉导航 -->
<div
  id="mobile-drawer"
  class="bg-gradient-start tablet:flex fixed inset-y-0 left-0 z-50 hidden h-screen w-[70vw] min-w-64 -translate-x-full transform px-4 pt-3 shadow-lg backdrop-blur-sm transition-transform duration-300 md:px-0"
  role="dialog"
  aria-label={t(locale, 'drawer.navMenu')}
  aria-modal="true"
>
  <div class="flex h-full w-full flex-col overflow-auto">
    <div class="flex items-center">
      <button id="close-drawer" aria-label={t(locale, 'drawer.close')} class="invisible">
        <Icon name="ri:close-line" class="h-6 w-6" />
      </button>
      {localeEntries.length > 1 && (
        <details class="language-switcher group relative ml-auto mr-4">
          <summary
            class="flex cursor-pointer list-none items-center gap-1.5 rounded-lg px-2.5 py-1 text-sm text-white/70 transition-colors hover:bg-white/10 hover:text-white [&::-webkit-details-marker]:hidden"
            aria-label={t(locale, 'common.language')}
          >
            <Icon name="ri:translate" class="size-4" />
            <span>{getLocaleLabel(locale)}</span>
            <Icon name="ri:arrow-down-s-line" class="size-4 transition-transform duration-200 group-open:rotate-180" />
          </summary>
          <div class="absolute right-0 top-full z-10 mt-1 flex min-w-28 flex-col overflow-hidden rounded-lg bg-black/40 shadow-lg backdrop-blur-sm">
            {localeEntries.map((entry) => {
              const isActive = entry.code === locale;
              return (
                <a
                  href={getAlternateUrl(Astro.url.pathname, entry.code)}
                  class:list={[
                    'px-4 py-2 text-sm transition-colors',
                    isActive
                      ? 'bg-gradient-shoka-button font-medium text-white'
                      : 'text-white/70 hover:bg-white/10 hover:text-white',
                  ]}
                  aria-current={isActive ? 'true' : undefined}
                >
                  {entry.label}
                </a>
              );
            })}
          </div>
        </details>
      )}
    </div>
    <HomeSider className="tablet:flex tablet:mt-0 mt-4 hidden w-full min-w-full p-0" isDrawer type={type} post={post} />
  </div>
</div>

<script>
  import { $isDrawerOpen, closeDrawer } from '@store/modal';

  interface DrawerElements {
    drawer: HTMLElement | null;
    closeBtn: HTMLElement | null;
    overlay: HTMLElement | null;
  }

  const DRAWER_SELECTORS = {
    drawer: 'mobile-drawer',
    closeBtn: 'close-drawer',
    overlay: 'drawer-overlay',
  } as const;

  const DRAWER_CLASSES = {
    hidden: 'hidden',
    translateX: '-translate-x-full',
  } as const;

  class DrawerController {
    private elements: DrawerElements;
    private unsubscribe: (() => void) | null = null;

    constructor() {
      this.elements = this.initElements();
      if (this.validateElements()) {
        this.bindEvents();
        this.subscribeToStore();
      }
    }

    private initElements(): DrawerElements {
      return Object.entries(DRAWER_SELECTORS).reduce(
        (acc, [key, id]) => ({
          ...acc,
          [key]: document.getElementById(id),
        }),
        {} as DrawerElements,
      );
    }

    private validateElements(): boolean {
      return Object.entries(this.elements).every(([key, element]) => {
        const exists = !!element;
        if (!exists) {
          console.error(`抽屉元素未找到: ${key}`);
        }
        return exists;
      });
    }

    private bindEvents(): void {
      document.addEventListener('keydown', this.handleKeyDown);
      this.elements.closeBtn?.addEventListener('click', this.handleClose);
      this.elements.overlay?.addEventListener('click', this.handleClose);
      this.elements.drawer?.addEventListener('click', this.handleDrawerClick);
    }

    /**
     * Subscribe to Nanostores $isDrawerOpen state
     */
    private subscribeToStore(): void {
      this.unsubscribe = $isDrawerOpen.subscribe((isOpen) => {
        if (isOpen) {
          this.open();
        } else {
          this.close();
        }
      });
    }

    private handleKeyDown = (e: KeyboardEvent): void => {
      if (e.key === 'Escape' && $isDrawerOpen.get()) {
        closeDrawer();
      }
    };

    private handleClose = (): void => {
      closeDrawer();
    };

    private handleDrawerClick = (e: MouseEvent): void => {
      const details = this.elements.drawer?.querySelector('details.language-switcher');
      if (details?.hasAttribute('open') && !details.contains(e.target as Node)) {
        details.removeAttribute('open');
      }
    };

    private open(): void {
      const { drawer, overlay, closeBtn } = this.elements;
      if (!drawer || !overlay) return;

      drawer.classList.remove(DRAWER_CLASSES.translateX);
      overlay.classList.remove(DRAWER_CLASSES.hidden);
      document.body.style.overflow = 'hidden';
      closeBtn?.focus();
    }

    private close(): void {
      const { drawer, overlay } = this.elements;
      if (!drawer || !overlay) return;

      drawer.classList.add(DRAWER_CLASSES.translateX);
      overlay.classList.add(DRAWER_CLASSES.hidden);
      drawer.querySelector('details.language-switcher')?.removeAttribute('open');
      document.body.style.overflow = '';
    }

    public destroy(): void {
      document.removeEventListener('keydown', this.handleKeyDown);
      this.elements.closeBtn?.removeEventListener('click', this.handleClose);
      this.elements.overlay?.removeEventListener('click', this.handleClose);
      this.elements.drawer?.removeEventListener('click', this.handleDrawerClick);

      // Unsubscribe from nanostore
      if (this.unsubscribe) {
        this.unsubscribe();
        this.unsubscribe = null;
      }
    }
  }

  let drawerController: DrawerController;

  function init() {
    drawerController?.destroy();
    drawerController = new DrawerController();
  }

  // 首次加载时立即初始化（处理 script 加载晚于 astro:page-load 的情况）
  if (document.readyState !== 'loading') {
    init();
  }
  // 监听后续页面导航
  document.addEventListener('astro:page-load', init);

  // Close drawer before page navigation to prevent it from staying open
  document.addEventListener('astro:before-preparation', () => {
    closeDrawer();
  });
</script>
