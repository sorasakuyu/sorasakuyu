---
import { CONTENT_PADDING } from '@constants/layout';
import { type Category, getPostSlug, getPostsByCategory, translateCategoryName } from '@lib/content';
import { displayDate } from '@lib/date';
import { encodeSlug } from '@lib/route';
import { cn } from '@lib/utils';
import { getLocaleFromUrl, localizedPath, t } from '@/i18n';
import SubCategory from './SubCategory.astro';

interface Props {
  categories: Category[];
  countMap: Record<string, number>;
  rootCategory: Category | null;
}
const { categories, countMap, rootCategory } = Astro.props;
const locale = getLocaleFromUrl(Astro.url.pathname);
const posts = await getPostsByCategory(rootCategory?.name ?? '', locale);
---

<div class={`shadow-box mx-0 flex w-full flex-col bg-gradient-start ${CONTENT_PADDING.normal}`}>
  <h2
    class={cn('shoka-decoration-circle px-6 group relative py-5 text-2xl/9 font-bold', {
      'has-children': posts?.length || rootCategory?.children?.length,
    })}
  >
    <a href={localizedPath('/', locale)} class="dashed-border text-muted-foreground hover:text-blue border-b"> {t(locale, 'nav.home')} </a>
    <span class="text-muted-foreground mx-2 text-xl">/</span>
    <span class="text-muted-foreground">{rootCategory ? translateCategoryName(rootCategory.name, locale) : ''}</span>
    <span class="text-muted-foreground mx-2 text-xl">{t(locale, 'category.categoryLabel')}</span>
  </h2>

  <div class="flex w-full flex-col">
    {
      categories.map(
        (category) =>
          category?.children?.length && (
            <div class="category-first-level-container flex flex-col">
              {category?.children?.length &&
                category.children.map((child) => (
                  <SubCategory category={child} parentName={category.name} countMap={countMap} />
                ))}
            </div>
          ),
      )
    }
    {
      posts?.length && (
        <div class="category-second-level-container flex flex-col">
          {posts.map((post) => (
            <p class="shoka-decoration-circle group text-primary hover:text-blue relative px-6 py-2 text-base/9">
              <span class="text-muted-foreground mr-2 text-xs">{displayDate.shortDate(post.data.date)}</span>
              <a href={localizedPath(`/post/${encodeSlug(getPostSlug(post))}`, locale)} class="dashed-border">
                {post?.data?.title}
              </a>
            </p>
          ))}
        </div>
      )
    }
  </div>
</div>
