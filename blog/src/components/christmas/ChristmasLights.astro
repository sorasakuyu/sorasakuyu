---
/**
 * 圣诞彩灯装饰组件
 * 悬挂在 Header 底部的装饰性彩灯，随 Header 一起移动
 *
 * 性能优化：
 * - 使用 opacity 动画代替 box-shadow 动画（避免 paint 操作）
 * - 静态 box-shadow 保持发光效果
 * - Tab 不可见时暂停动画
 * - Christmas 禁用时暂停动画
 */

// 灯泡数量：覆盖最大屏幕宽度 (灯泡间距约 52px，50 个足够覆盖 2600px+)
const lightCount = 50;
---

<ul class="lightrope" aria-hidden="true">
  {Array.from({ length: lightCount }).map(() => <li />)}
</ul>

<script>
  function initLightsVisibility() {
    // Tab 可见性检测 - 不可见时暂停动画以节省资源
    const handleVisibility = () => {
      document.documentElement.classList.toggle('lights-paused', document.hidden);
    };

    // 初始化时检查状态
    handleVisibility();

    document.addEventListener('visibilitychange', handleVisibility);
  }

  // 初始化
  if (document.readyState !== 'loading') {
    initLightsVisibility();
  }
  document.addEventListener('astro:page-load', initLightsVisibility);
</script>

<style>
  .lightrope {
    --globe-width: 12px;
    --globe-height: 28px;
    --globe-spacing: 40px;
    --globe-spread: 6px;
    --light-dim-opacity: 0.4;

    /* 更鲜艳的圣诞配色 */
    --light-red: 255, 40, 40;
    --light-green: 50, 205, 50;
    --light-gold: 255, 200, 50;
    --light-blue: 100, 180, 255;

    position: absolute;
    top: calc(100% - 20px);
    left: 0;
    width: 100%;
    margin: 0;
    padding: 0;
    text-align: center;
    white-space: nowrap;
    overflow-x: clip;
    overflow-y: visible;
    pointer-events: none;
  }

  .lightrope li {
    position: relative;
    display: inline-block;
    width: var(--globe-width);
    height: var(--globe-height);
    margin: calc(var(--globe-spacing) / 2);
    padding: 0;
    list-style: none;
    border-radius: 50%;
    /* 鲜艳的背景色和强烈的发光效果 */
    background: rgb(var(--light-red));
    box-shadow:
      0px 4px 24px var(--globe-spread) rgba(var(--light-red), 1),
      0px 2px 8px 2px rgba(var(--light-red), 0.6);
    /* opacity + scale 动画 - 都是 GPU 合成 */
    animation: flash-bulb 1.2s ease-in-out infinite;
  }

  /* 绿色灯泡 */
  .lightrope li:nth-child(2n + 1) {
    background: rgb(var(--light-green));
    box-shadow:
      0px 4px 24px var(--globe-spread) rgba(var(--light-green), 1),
      0px 2px 8px 2px rgba(var(--light-green), 0.6);
  }

  /* 金色灯泡 */
  .lightrope li:nth-child(4n + 2) {
    background: rgb(var(--light-gold));
    box-shadow:
      0px 4px 28px var(--globe-spread) rgba(var(--light-gold), 1),
      0px 2px 10px 2px rgba(var(--light-gold), 0.7);
  }

  /* 蓝色灯泡 - 增加色彩丰富度 */
  .lightrope li:nth-child(6n + 4) {
    background: rgb(var(--light-blue));
    box-shadow:
      0px 4px 24px var(--globe-spread) rgba(var(--light-blue), 1),
      0px 2px 8px 2px rgba(var(--light-blue), 0.6);
  }

  /* 动画延迟 - 创造流水灯效果 */
  .lightrope li:nth-child(1) {
    animation-delay: 0s;
  }
  .lightrope li:nth-child(2) {
    animation-delay: 0.1s;
  }
  .lightrope li:nth-child(3) {
    animation-delay: 0.2s;
  }
  .lightrope li:nth-child(4) {
    animation-delay: 0.3s;
  }
  .lightrope li:nth-child(5) {
    animation-delay: 0.4s;
  }
  .lightrope li:nth-child(6) {
    animation-delay: 0.5s;
  }
  .lightrope li:nth-child(6n + 1) {
    animation-delay: 0s;
  }
  .lightrope li:nth-child(6n + 2) {
    animation-delay: 0.15s;
  }
  .lightrope li:nth-child(6n + 3) {
    animation-delay: 0.3s;
  }
  .lightrope li:nth-child(6n + 4) {
    animation-delay: 0.45s;
  }
  .lightrope li:nth-child(6n + 5) {
    animation-delay: 0.6s;
  }
  .lightrope li:nth-child(6n) {
    animation-delay: 0.75s;
  }

  /* 时长变化 - 增加随机感 */
  .lightrope li:nth-child(odd) {
    animation-duration: 1.4s;
  }

  .lightrope li:nth-child(3n) {
    animation-duration: 1s;
  }

  /* 灯座 */
  .lightrope li::before {
    content: '';
    position: absolute;
    top: calc(0px - var(--globe-height) / 6);
    left: 1px;
    width: calc(var(--globe-width) - 2px);
    height: calc(var(--globe-height) / 3);
    background: hsl(var(--background) / 0.6);
    border-radius: 3px;
  }

  /* 连接电线 */
  .lightrope li::after {
    content: '';
    position: absolute;
    top: calc(0px - var(--globe-height) / 2);
    left: calc(var(--globe-width) - 3px);
    width: calc(var(--globe-spacing) + 12px);
    height: calc(var(--globe-height) / 3 * 2);
    border-bottom: solid hsl(var(--background) / 0.6) 2px;
    border-radius: 50%;
  }

  /* 最后一个灯泡不需要连接线 */
  .lightrope li:last-child::after {
    content: none;
  }

  /* 第一个灯泡左移，隐藏左边缘 */
  .lightrope li:first-child {
    margin-left: calc(0px - var(--globe-spacing));
  }

  /* opacity + scale 动画 - GPU 合成，无 paint 开销 */
  @keyframes flash-bulb {
    0%,
    100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: var(--light-dim-opacity);
      transform: scale(0.9);
    }
  }

  /* 暂停动画：Tab 不可见时 */
  :global(html.lights-paused) .lightrope li {
    animation-play-state: paused;
  }

  /* 暂停动画：Christmas 禁用时 */
  :global(html:not(.christmas)) .lightrope li {
    animation-play-state: paused;
  }

  /* 无障碍：减少动画 */
  @media (prefers-reduced-motion: reduce) {
    .lightrope li {
      animation: none;
    }
  }

  /* 根据 christmas 状态控制显示/隐藏 */
  :global(html:not(.christmas)) .lightrope {
    opacity: 0;
    transform: translateY(-40px);
    pointer-events: none;
  }

  .lightrope {
    transition:
      opacity 0.3s ease-out,
      transform 0.3s ease-out;
  }

  @media (prefers-reduced-motion: reduce) {
    .lightrope {
      transition: none;
    }
  }
</style>
