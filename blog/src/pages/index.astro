---
import HomeSider from '@components/layout/HomeSider.astro';
import PostList from '@components/post/PostList.astro';
import Cover from '@components/ui/cover/Cover.astro';
import { CONTENT_PADDING, PAGINATION } from '@constants/layout';
import { seoConfig, siteConfig } from '@constants/site-config';
import Layout from '@layouts/Layout.astro';
import TwoColumnLayout from '@layouts/TwoColumnLayout.astro';
import { getHomePagePosts } from '@lib/content';
import { toPostCardDataList } from '@lib/content/transforms';
import type { Page } from 'astro';
import type { BlogPost } from 'types/blog';
import CategoryCards from '@/components/post/CategoryCards.astro';
import Divider from '@/components/ui/divider';
import { getLocaleFromUrl, localizedPath, t } from '@/i18n';

const locale = getLocaleFromUrl(Astro.url.pathname);

// 使用优化的单次查询获取所有首页数据
const { highlightedPosts, stickyPosts: normalStickyPosts, regularPosts } = await getHomePagePosts(locale);

// 将高亮系列文章放在置顶列表开头（转换为卡片数据）
const stickyPosts = toPostCardDataList([...highlightedPosts, ...normalStickyPosts], locale);

// 首页显示前N篇普通文章（不含系列文章）
const { pageSize } = PAGINATION;
const regularPostsSlice = regularPosts.slice(0, pageSize);
const posts = toPostCardDataList(regularPostsSlice, locale);
const totalRegularPosts = regularPosts.length;

const homeUrl = localizedPath('/', locale);
const postsBaseUrl = localizedPath('/posts', locale);

const page: Page<BlogPost> = {
  data: regularPostsSlice,
  start: 0,
  end: Math.min(pageSize - 1, regularPostsSlice.length - 1),
  size: pageSize,
  total: totalRegularPosts,
  currentPage: 1,
  lastPage: Math.ceil(totalRegularPosts / pageSize),
  url: {
    current: homeUrl,
    prev: undefined,
    next: totalRegularPosts > pageSize ? `${postsBaseUrl}/2` : undefined,
    first: homeUrl,
    last: `${postsBaseUrl}/${Math.ceil(totalRegularPosts / pageSize)}`,
  },
};
---

<Layout title={seoConfig.title}>
  <TwoColumnLayout>
    <Cover slot="cover" />
    <HomeSider slot="sider" />
    <div
      class={`bg-gradient-start shadow-box tablet:shadow-none flex flex-col gap-4 overflow-hidden  ${CONTENT_PADDING.standard}`}
    >
      {stickyPosts.length > 0 && (
        <>
          <Divider>{t(locale, 'post.stickyPosts')}</Divider>
          <PostList posts={stickyPosts} showPaginator={false} />
        </>
      )}
      <Divider>{t(locale, 'post.postList')}</Divider>
      <PostList posts={posts} page={page} showPaginator={true} baseUrl={postsBaseUrl} isHomePage={true} />
      {!!siteConfig?.featuredCategories?.length && (
        <>
          <Divider className="mt-6">{t(locale, 'post.featuredCategories')}</Divider>
          <CategoryCards />
        </>
      )}
    </div>
  </TwoColumnLayout>
</Layout>
