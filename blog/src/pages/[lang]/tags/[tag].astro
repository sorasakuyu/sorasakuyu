---
import { getSortedPosts, normalizeTag } from '@lib/content';
import { defaultLocale, localeList } from '@/i18n/config';
import TagPage from '../../tags/[tag].astro';

export async function getStaticPaths() {
  const nonDefaultLocales = localeList.filter((l) => l !== defaultLocale);
  const paths = [];

  for (const lang of nonDefaultLocales) {
    const posts = await getSortedPosts(lang);
    const tags = new Set<string>();

    for (const post of posts) {
      const postTags = post.data.tags || [];
      for (const tag of postTags) {
        tags.add(normalizeTag(tag));
      }
    }

    for (const tag of tags) {
      paths.push({
        params: { lang, tag: normalizeTag(tag).replace(/\//g, '-') },
        props: {
          posts: posts.filter((post) => post.data.tags?.some((tg) => normalizeTag(tg) === tag)),
          tag,
        },
      });
    }
  }

  return paths;
}

const { tag, posts } = Astro.props;
---
<TagPage tag={tag} posts={posts} />
