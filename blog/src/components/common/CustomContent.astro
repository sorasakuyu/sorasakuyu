---
import { EmbedHydrator } from '@components/embed/EmbedHydrator';
import ContentEnhancer from '@components/markdown/ContentEnhancer';
import type { ContentConfig } from '@constants/content-config';
import { defaultContentConfig } from '@constants/content-config';
import type { AstroComponentFactory } from 'astro/runtime/server/index.js';
import { christmasConfig } from '@/constants/site-config';

interface Props {
  Content?: AstroComponentFactory;
  config?: Partial<ContentConfig>;
}

const { Content, config = {} } = Astro.props;
const finalConfig = { ...defaultContentConfig, ...config };
---

<div
  class:list={['custom-content', { 'relative z-5': christmasConfig.enabled && christmasConfig.features.snowfall }]}
  data-config={JSON.stringify(finalConfig)}
>
  {Content ? <Content /> : <slot />}
</div>

{/* React-based content enhancement (code blocks, mermaid, infographic toolbars) */}
{finalConfig.enhanceCodeBlock && (
  <ContentEnhancer
    client:idle
    enableCopy={finalConfig.enableCodeCopy}
    enableFullscreen={finalConfig.enableCodeFullscreen}
    enableQuiz={finalConfig.enableQuiz ?? true}
    enableEncryptedBlock={finalConfig.enableEncryptedBlock ?? false}
  />
)}

{/* Only load EmbedHydrator if tweet embeds are enabled (link previews are now server-rendered) */}
{finalConfig.enableTweetEmbed && <EmbedHydrator client:load />}

<script>
  import { enhanceImages } from '@lib/image-enhancer';
  import { enhanceLinkPreviews } from '@lib/link-preview-enhancer';

  let spoilerJsLoaded = false;

  // Content enhancement script - handles non-React enhancements
  function enhanceContent() {
    const contentContainer = document.querySelector('.custom-content');
    if (!contentContainer) return;

    // Avoid re-enhancing
    if (contentContainer.getAttribute('data-enhanced') === 'true') return;

    // Dynamically load spoilerjs when <spoiler-span> elements are present
    if (!spoilerJsLoaded && contentContainer.querySelector('spoiler-span')) {
      spoilerJsLoaded = true;
      import('spoilerjs/spoiler-span').catch(() => {
        spoilerJsLoaded = false;
      });
    }

    // Get configuration from data attribute
    const configData = contentContainer.getAttribute('data-config');
    const config = configData
      ? JSON.parse(configData)
      : { addBlankTarget: true, smoothScroll: true, addHeadingLevel: true };

    // Add target="_blank" to external links
    if (config.addBlankTarget) {
      const links = contentContainer.querySelectorAll('a[href]');
      links.forEach((link: Element) => {
        const anchor = link as HTMLAnchorElement;
        const href = anchor.getAttribute('href') || '';
        if (href.startsWith('http') || href.startsWith('//')) {
          anchor.setAttribute('target', '_blank');
        }
      });
    }

    // Add smooth scroll to anchor links
    if (config.smoothScroll) {
      const anchorLinks = contentContainer.querySelectorAll('a.anchor-link[href^="#"]');
      anchorLinks.forEach((link: Element) => {
        const anchor = link as HTMLAnchorElement;
        anchor.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = anchor.getAttribute('href')?.substring(1);
          if (!targetId) return;
          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            history.pushState(null, '', `#${targetId}`);
          }
        });
      });
    }

    // Add heading level labels (H1, H2, etc.)
    if (config.addHeadingLevel) {
      const headings = contentContainer.querySelectorAll('h1, h2, h3, h4, h5, h6');
      headings.forEach((heading: Element) => {
        const level = heading.tagName[1];
        heading.setAttribute('data-level', `H${level}`);
      });
    }

    // Enhance images with loading states
    enhanceImages(contentContainer);

    // Enhance link preview images with error handling
    enhanceLinkPreviews(contentContainer);

    // Tab group switching logic
    const tabHeaders = contentContainer.querySelectorAll<HTMLElement>('.tab-header[role="tab"]');
    tabHeaders.forEach((header) => {
      header.addEventListener('click', () => {
        const groupId = header.dataset.tabGroup;
        const tabIndex = header.dataset.tabIndex;
        if (!groupId || tabIndex === undefined) return;

        const group = contentContainer.querySelector(`.tab-group[data-tab-group="${groupId}"]`);
        if (!group) return;

        // Update headers
        group.querySelectorAll<HTMLElement>('.tab-header').forEach((h) => {
          h.setAttribute('aria-selected', String(h.dataset.tabIndex === tabIndex));
        });

        // Update panels
        group.querySelectorAll<HTMLElement>('.tab-panel').forEach((panel) => {
          panel.classList.toggle('active', panel.dataset.tabIndex === tabIndex);
        });
      });
    });

    // Blur spoiler click-to-reveal (default spoilers handled by spoilerjs)
    const blurSpoilers = contentContainer.querySelectorAll<HTMLElement>('.spoiler.blur');
    blurSpoilers.forEach((spoiler) => {
      spoiler.addEventListener('click', () => spoiler.classList.toggle('revealed'));
    });

    // Mark as enhanced
    contentContainer.setAttribute('data-enhanced', 'true');
  }

  // Run on page load
  document.addEventListener('astro:page-load', () => {
    const contentContainer = document.querySelector('.custom-content');
    if (contentContainer) {
      contentContainer.removeAttribute('data-enhanced');
    }
    enhanceContent();
  });

  // Re-enhance after encrypted post decryption (new DOM needs external links, anchors, etc.)
  document.addEventListener('content:decrypted', () => {
    const contentContainer = document.querySelector('.custom-content');
    if (contentContainer) {
      contentContainer.removeAttribute('data-enhanced');
    }
    enhanceContent();
  });

  // Run immediately if already loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', enhanceContent);
  } else {
    enhanceContent();
  }
</script>
